---
title: "Soil-Mates"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#### Packages
```{r}
library(dplyr)
library(vegan)
library(tidyverse)
library(ggpubr)
library(ggtree)
library(vegan)
library(ape)
library(ggplot2)
library(gridExtra)
```

#### Importing all at once
```{r}
temp <- list.files("./Data",pattern="*.csv", full.names = T) #creates an object that contains a string of file names with directory so they can be located
Dat <- list() # creates an empty vector used in the for loop
for (i in seq_along(temp)) { # creates a list of dataframes
  Dat[[i]] <- read.csv(
    file = temp[[i]]
  )
}
names <- c("En10", "En20", "Ar10", "Ba10", "Fu10", "Ar20", "Ba20", "Fu20", "En") 
Dat <- set_names(Dat, names) # sets the names for the data frames in Dat
```
#### Preprocessing before data is combined
```{r}
Dat$Fu10 <- Dat$Fu10 %>% #Removes extras from Fungi
  select(-Trophic.Mode,-Guild,-Confidence.Ranking)
```
```{r}
Dat$Fu20 <- Dat$Fu20 %>% #Removes extras from Fungi
  select(-Trophic.Mode,-Guild,-Confidence.Ranking) 
```
```{r}
Dat$Ba10 <- Dat$Ba10 %>% # Fixes capitalization
  rename(Cluster=(cluster)) 
```
```{r}
Dat$Ar10 <- Dat$Ar10 %>% # Fixes capitalization
  rename(Phyla=(phylum),
         Class=(class),
         Order=(order),
         Family=(family))
```
```{r}
Dat$En10 <- Dat$En10 %>% # Possibly unnecessary
  rename(Archaea=(Archaea_010cm),
         Bacteria=(Bacteria_010cm),
         Fungi=(Fungi_010cm))
```

```{r}
Dat$En20 <- Dat$En20 %>% # Makes so that when both Enviro tables are combined names match
  rename(Clearcut=(CLF),
         Salvage=(Salv_log),
         Organic.Carbon=(Organic.Carbon_prop),
         Exc.Magnesium=(Exc..Magnesium),
         pH.CaCl2.=(pH.Level..CaCl2.),
         Archaea=(Archaea_020cm),
         Bacteria=(Bacteria_020cm),
         Fungi=(Fungi_020cm)) %>%
  mutate(TSD= as.numeric(TSD)-1)
```
#### Combines datasets - reproducibility likely can be enhanced - this one uses the Importing all at once
```{r}
En<-bind_rows(Dat$En10,Dat$En20) #Combines Enviro tables into one dataset
D10<-bind_rows(Dat$Ar10,Dat$Ba10,Dat$Fu10) # Combines all for at depth 10 
D20<-bind_rows(Dat$Ar20,Dat$Ba20,Dat$Fu20) # Combines all microbes for for depth of 20
```

```{r}
#Writing En into Data folder to open in Question 2 rmd
write.csv(En, file = "./Data/En.csv")
```

#### Please ignore - this belongs in question 1
#### Diversity
```{r}
tD10 <- D10 #creates new object to be manipulated for diversity calculations
tD10 <- tD10 %>%
  select(-Cluster, -Sample, -Phyla, -Class, -Order, -Family)
tD10 <- t(tD10) #Transposes file
```

# calculates diversity for depth 0-10cm
```{r}
Div1 <- diversity(tD10, index = "shannon", MARGIN = 1, base= exp(1))
```

# transposes depth 20-30cm file
```{r}
tD20 <- D20
tD20 <- tD20 %>%
  select(-Cluster, -Sample, -Phyla, -Class, -Order, -Family)
tD20 <- t(tD20)
```

#calculates diveristy for depth of 20-30cm
```{r}
Div2 <- diversity(tD20, index = "shannon", MARGIN = 1, base= exp(1))
```

## T-test of diversity between depth
```{r}
t.test(Div1, Div2)
```
```{r}
EnQ1 <- En
EnQ1$Div <- c(Div1, Div2)
```

#### Add proper names to a new column for disturbance History in a New environemental table using a for loop
```{r}
EnM <- EnQ1
for (i in 1:nrow(EnM)) { 
  if (EnM$TSD[i] == 167) {
  EnM$Disturbance_History[i] <- "1850F"
  } else if (EnM$TSD[i] == 78) {
  EnM$Disturbance_History[i] <- "1939F" 
  } else if ((EnM$No.Fires[i]== 2) && (EnM$TSD[i] == 34)) {
  EnM$Disturbance_History[i] <- "1939/1983F"
  } else if ((EnM$No.Fires[i]== 2) && (EnM$Salvage[i] == 0) && (EnM$Clearcut[i] == 0) && (EnM$TSD[i] == 8)) {
  EnM$Disturbance_History[i] <- "1939/2009F" 
  } else if (EnM$No.Fires[i]== 3) {
  EnM$Disturbance_History[i] <- "1939/1983/2009F" 
  } else if ((EnM$No.Fires[i]== 1) && (EnM$Clearcut[i] == 1) && (EnM$TSD[i] == 34)) {
  EnM$Disturbance_History[i] <- "1939F/1980CC"
  } else if ((EnM$No.Fires[i]== 1) && (EnM$Clearcut[i] == 1) && (EnM$TSD[i] == 8)) {
  EnM$Disturbance_History[i] <- "1939F/2009CC"
  } else if (EnM$Salvage[i] == 1) {
  EnM$Disturbance_History[i] <- "1939/2009F/2009SL"
  } else if ((EnM$No.Fires[i]== 2) && (EnM$Clearcut[i] == 1) && (EnM$TSD[i] == 8)) {
  EnM$Disturbance_History[i] <- "1939/1983F/2009CC"
  } 
}
```
### Stats for individual varibles
```{r}
two.way1 <- aov(Div ~ No.Fires + Depth, data = EnQ1)
summary(two.way1)
two.way2 <- aov(Div ~ TSD + Depth, data = EnQ1)
summary(two.way2)
two.way3 <- aov(Div ~ Clearcut + Depth, data = EnQ1)
summary(two.way3)
two.way4 <- aov(Div ~ Salvage + Depth, data = EnQ1)
summary(two.way4)
two.way5 <- aov(Div ~ Disturbance_History + Depth, data = EnM)
summary(two.way5)
```

#### - borrowed from Logan
```{r}
theme_boxplot_one <- function (base_size =12, base_family = ""){
  theme_classic(base_size = base_size, base_family = base_family) %+replace%
    theme(
      axis.text = element_text(colour = "black"),
      axis.title.x = element_text(size=12),
      axis.text.x = element_text(size=9),
      axis.title.y = element_text(size=12, angle=90),
      axis.text.y = element_text(size=9),
      axis.ticks = element_blank(),
      panel.background = element_rect(fill = "white"),
      panel.border = element_blank(),
      plot.title= element_text(face="bold", size=24)
    )
}
clearcutpal <- c("#7f4f24", "#718355")
salvagepal <- c("#e9972d", "#15616d")
fullpal <- c(clearcutpal, salvagepal, "#732626", "#CB8282", "#BA82CB", "#82CBAA", "#C3CB82") 
```

#### Plot of diversity by depth
```{r}
EnM_mean <- EnM %>% 
  group_by(Depth) %>% 
  summarize(average = mean(Div)) %>%
  ungroup()
```

```{r}
QP1 <- ggplot(EnM, aes(x=Depth, y=Div)) +
    geom_boxplot(aes(colour=I("black"), fill=Depth)) +  
    labs(y=NULL, 
         x="Depth of sample",
         fill="Disturbance History") + 
  scale_x_discrete(labels=c("0-10cm", "20-30cm")) +
        theme_boxplot_one() + 
  geom_point(data = EnM_mean, 
             mapping = aes(x= Depth, y = average),
             color="red") +
   geom_line(data = EnM_mean, 
            mapping = aes(x = Depth, y = average, group=1)) + 
  stat_compare_means(method = "t.test", label.x= 0.5) + 
  theme(legend.position = "none") +
  scale_fill_manual(values = clearcutpal)
QP1
```

#### Examing individual disturbance types effects
```{r}
plot1 <- ggplot(EnM, aes(x=Depth, y=Div)) + # Makes a plot with a legend
    geom_boxplot(aes(colour=I("black"), fill=Depth)) +
  theme_boxplot_one() + 
  scale_fill_manual(values = clearcutpal)
extract_legend <- function(my_ggp) { #Custom function to extract just legends
  step1 <- ggplot_gtable(ggplot_build(my_ggp))
  step2 <- which(sapply(step1$grobs, function(x) x$name) == "guide-box")
  step3 <- step1$grobs[[step2]]
  return(step3)
}
# Apply user-defined function to extract legend for us in a mutliplot
shared_legend <- extract_legend(plot1)
```

```{r}
plot2 <- ggplot(EnM, aes(x = as.factor(No.Fires), y = Div )) +
  stat_summary(aes(group = Depth, color = Depth, linetype = Depth), fun = mean, geom = "path", size =1) +
  stat_summary(aes(color = Depth, shape = Depth), fun = mean,
               geom = "errorbar", fun.max = function(x) mean(x) + sd(x),
               fun.min = function(x) mean(x) - sd(x),  size =1, width=.25,
               position=position_dodge(width=0.03)) +
  stat_summary(aes(color = Depth, shape = Depth), geom = "point",fun.y = "mean",size = 4) +
  scale_shape_manual(name = "Group", values = c(18, 16)) +
    xlab ('Number of Fire') +
  ylab(NULL) +
    theme_boxplot_one() +
  guides(shape = FALSE, linetype = FALSE) +
  theme(text = element_text(size = 14)) +
    guides(colour = guide_legend(override.aes = list(shape = c(18, 16)), 'Depth')) + 
  theme(legend.position = "none") +
  scale_colour_manual(values = fullpal, labels = c("0-10cm", "20-30cm"))

plot3 <- ggplot(EnM, aes(x = as.factor(Clearcut), y = Div )) +
  stat_summary(aes(group = Depth, color = Depth, linetype = Depth), fun = mean, geom = "path", size =1) +
  stat_summary(aes(color = Depth, shape = Depth), fun = mean,
               geom = "errorbar", fun.max = function(x) mean(x) + sd(x),
               fun.min = function(x) mean(x) - sd(x),  size =1, width=.25,
               position=position_dodge(width=0.03)) +
  stat_summary(aes(color = Depth, shape = Depth), geom = "point",fun.y = "mean",size = 4) +
  scale_shape_manual(name = "Group", values = c(18, 16)) +
    xlab ('Clearcut') +
  ylab(NULL) +
    theme_boxplot_one() +
  guides(shape = FALSE, linetype = FALSE) +
  theme(text = element_text(size = 14)) +
    guides(colour = guide_legend(override.aes = list(shape = c(18, 16)), 'Depth')) + 
  theme(legend.position = "none") +
  scale_colour_manual(values = fullpal, labels = c("0-10cm", "20-30cm"))

plot4 <- ggplot(EnM, aes(x = as.factor(Salvage), y = Div )) +
  stat_summary(aes(group = Depth, color = Depth, linetype = Depth), fun = mean, geom = "path", size =1) +
  stat_summary(aes(color = Depth, shape = Depth), fun = mean,
               geom = "errorbar", fun.max = function(x) mean(x) + sd(x),
               fun.min = function(x) mean(x) - sd(x),  size =1, width=.25,
               position=position_dodge(width=0.03)) +
  stat_summary(aes(color = Depth, shape = Depth), geom = "point",fun.y = "mean",size = 4) +
  scale_shape_manual(name = "Group", values = c(18, 16)) +
    xlab ('Salvage Logging') +
   ylab(NULL) +
    theme_boxplot_one() +
  guides(shape = FALSE, linetype = FALSE) +
  theme(text = element_text(size = 14)) +
    guides(colour = guide_legend(override.aes = list(shape = c(18, 16)), 'Depth')) + 
  theme(legend.position = "none") +
  scale_colour_manual(values = fullpal, labels = c("0-10cm", "20-30cm"))

plot5 <- ggplot(EnM, aes(x = as.factor(TSD), y = Div )) +
  stat_summary(aes(group = Depth, color = Depth, linetype = Depth), fun = mean, geom = "path", size =1) +
  stat_summary(aes(color = Depth, shape = Depth), fun = mean,
               geom = "errorbar", fun.max = function(x) mean(x) + sd(x),
               fun.min = function(x) mean(x) - sd(x),  size =1, width=.25, 
               position=position_dodge(width=0.03)) +
  stat_summary(aes(color = Depth, shape = Depth), geom = "point",fun.y = "mean",size = 4) +
  scale_shape_manual(name = "Group", values = c(18, 16)) +
    xlab ('Time Since Disturbance (Years)') +
  ylab(NULL) +
    theme_boxplot_one() +
  guides(shape = FALSE, linetype = FALSE) +
  theme(text = element_text(size = 14)) +
    guides(colour = guide_legend(override.aes = list(shape = c(18, 16)), 'Depth')) + 
  theme(legend.position = "none") + 
  scale_colour_manual(values = fullpal, labels = c("0-10cm", "20-30cm"))
```


```{r}
PlotB<- grid.arrange( arrangeGrob(plot2, plot3, plot4, plot5, ncol=2), 
                  shared_legend, nrow = 2, heights = c(5, 1))
             
```

```{r}
EnM_mean2 <- EnM %>% 
  group_by(Disturbance_History) %>% 
  summarize(average = mean(Div)) %>%
  ungroup()
```

# By disturbance history - still needs fixing
```{r}
QP6<- ggplot(EnM, aes(x=reorder(Disturbance_History,-TSD), y=Div)) +
    geom_boxplot(aes(colour=I("black"), fill=Disturbance_History)) +  
    labs(y=NULL, 
         x="Disturbance History",
         fill="Disturbance History") + 
   geom_point(data = EnM_mean2, 
             mapping = aes(x= Disturbance_History, y = average),
             color="red") +
   geom_line(data = EnM_mean2, 
            mapping = aes(x = Disturbance_History, y = average, group=1)) + 
  theme_boxplot_one() +
  theme(legend.position = "none", axis.text.x = element_text(angle = 15, vjust = 1, hjust=1)) +
  scale_fill_manual(values = fullpal)
QP6
```

```{r}
pdf("Question1Plots.pdf") 
PLOT21<-grid.arrange(QP1, PlotB, QP6, ncol=1, nrow=3, left = "Shannon's Diversity")
ggsave( "Question1Plots.pdf", plot=PLOT21, width =40, height = 40, units = "cm")
```

      