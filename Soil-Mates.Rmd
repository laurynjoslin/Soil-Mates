---
title: "Soil-Mates"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#### Packages
```{r}
library(dplyr)
library(vegan)
library(tidyverse)
library(ggpubr)  # used to add stats in plots 
library(ggtree)
library(vegan)
library(ape)
library(ggplot2)
library(gridExtra)
```

#### Importing all at once
```{r}
temp <- list.files("./Data",pattern="*.csv", full.names = T) #creates an object that contains a string of file names with directory so they can be located
Dat <- list() # creates an empty vector used in the for loop
for (i in seq_along(temp)) { # creates a list (I dont know if this is the right term) of dataframes
  Dat[[i]] <- read.csv(
    file = temp[[i]]
  )
}
names <- c("En10", "En20", "Ar10", "Ba10", "Fu10", "Ar20", "Ba20", "Fu20", "En") #probably a better way to name the elements in Dat - increase reproducibility
Dat <- set_names(Dat, names) # sets the names for the data frames in Dat
```
#### Preprocessing before data is combined
```{r}
Dat$Fu10 <- Dat$Fu10 %>% #Removes extras from Fungi
  select(-Trophic.Mode,-Guild,-Confidence.Ranking)
```
```{r}
Dat$Fu20 <- Dat$Fu20 %>% #Removes extras from Fungi
  select(-Trophic.Mode,-Guild,-Confidence.Ranking) 
```
```{r}
Dat$Ba10 <- Dat$Ba10 %>% # Fixes capitalization
  rename(Cluster=(cluster)) 
```
```{r}
Dat$Ar10 <- Dat$Ar10 %>% # Fixes capitalization
  rename(Phyla=(phylum),
         Class=(class),
         Order=(order),
         Family=(family))
```
```{r}
Dat$En10 <- Dat$En10 %>% # Possibly unnecessary
  rename(Archaea=(Archaea_010cm),
         Bacteria=(Bacteria_010cm),
         Fungi=(Fungi_010cm))
```

```{r}
Dat$En20 <- Dat$En20 %>% # Makes so that when both Enviro tables are combined names match
  rename(Clearcut=(CLF),
         Salvage=(Salv_log),
         Organic.Carbon=(Organic.Carbon_prop),
         Exc.Magnesium=(Exc..Magnesium),
         pH.CaCl2.=(pH.Level..CaCl2.),
         Archaea=(Archaea_020cm),
         Bacteria=(Bacteria_020cm),
         Fungi=(Fungi_020cm)) %>%
  mutate(TSD= as.numeric(TSD)-1)
```
#### Combines datasets - reproducibility likely can be enhanced - this one uses the Importing all at once
```{r}
En<-bind_rows(Dat$En10,Dat$En20) #Combines Enviro tables into one dataset
D10<-bind_rows(Dat$Ar10,Dat$Ba10,Dat$Fu10) # Combines all for at depth 10 
D20<-bind_rows(Dat$Ar20,Dat$Ba20,Dat$Fu20) # Combines all microbes for for depth of 20
```

```{r}
#Writing En into Data folder to open in Question 2 rmd
write.csv(En, file = "./Data/En.csv")
```

#### Please ignore - this belongs in question 1
#### Diversity
```{r}
tD10 <- D10 #creates new object to be manipulated for diversity calculations
tD10 <- tD10 %>%
  select(-Cluster, -Sample, -Phyla, -Class, -Order, -Family)
tD10 <- t(tD10) #Transposes file
```

# calculates diversity for depth 0-10cm
```{r}
Div1 <- diversity(tD10, index = "shannon", MARGIN = 1, base= exp(1))
```

# transposes depth 20 file
```{r}
tD20 <- D20
tD20 <- tD20 %>%
  select(-Cluster, -Sample, -Phyla, -Class, -Order, -Family)
tD20 <- t(tD20)
```

#calculates diveristy for depth of 20-30cm
```{r}
Div2 <- diversity(tD20, index = "shannon", MARGIN = 1, base= exp(1))
```

## T-test of diversity between 
```{r}
t.test(Div1, Div2)
```
```{r}
EnQ1 <- En
EnQ1$Div <- c(Div1, Div2)
```

#### Add proper names to a new column for disturbance History in a New environemental table using a for loop
```{r}
EnM <- EnQ1
for (i in 1:nrow(EnM)) { 
  if (EnM$TSD[i] == 167) {
  EnM$Disturbance_History[i] <- "1850F"
  } else if (EnM$TSD[i] == 78) {
  EnM$Disturbance_History[i] <- "1939F" 
  } else if ((EnM$No.Fires[i]== 2) && (EnM$TSD[i] == 34)) {
  EnM$Disturbance_History[i] <- "1939/1983F"
  } else if ((EnM$No.Fires[i]== 2) && (EnM$Salvage[i] == 0) && (EnM$Clearcut[i] == 0) && (EnM$TSD[i] == 8)) {
  EnM$Disturbance_History[i] <- "1939/2009F" 
  } else if (EnM$No.Fires[i]== 3) {
  EnM$Disturbance_History[i] <- "1939/1983/2009F" 
  } else if ((EnM$No.Fires[i]== 1) && (EnM$Clearcut[i] == 1) && (EnM$TSD[i] == 34)) {
  EnM$Disturbance_History[i] <- "1939F/1980CC"
  } else if ((EnM$No.Fires[i]== 1) && (EnM$Clearcut[i] == 1) && (EnM$TSD[i] == 8)) {
  EnM$Disturbance_History[i] <- "1939F/2009CC"
  } else if (EnM$Salvage[i] == 1) {
  EnM$Disturbance_History[i] <- "1939/2009F/2009SL"
  } else if ((EnM$No.Fires[i]== 2) && (EnM$Clearcut[i] == 1) && (EnM$TSD[i] == 8)) {
  EnM$Disturbance_History[i] <- "1939/1983F/2009CC"
  } 
}
unique(EnM$Disturbance_History) #checks unique to ensure I got all the every history
```
Stats for individual varibles
```{r}
two.way1 <- aov(Div ~ No.Fires + Depth, data = EnQ1)
summary(two.way1)
two.way2 <- aov(Div ~ TSD + Depth, data = EnQ1)
summary(two.way2)
two.way3 <- aov(Div ~ Clearcut + Depth, data = EnQ1)
summary(two.way3)
two.way4 <- aov(Div ~ Salvage + Depth, data = EnQ1)
summary(two.way4)
two.way5 <- aov(Div ~ Disturbance_History + Depth, data = EnM)
summary(two.way5)

```

#### - borrowed from logan
```{r}
theme_boxplot_one <- function (base_size =12, base_family = ""){
  theme_classic(base_size = base_size, base_family = base_family) %+replace%
    theme(
      axis.text = element_text(colour = "black"),
      axis.title.x = element_text(size=12),
      axis.text.x = element_text(size=9),
      axis.title.y = element_text(size=12, angle=90),
      axis.text.y = element_text(size=9),
      axis.ticks = element_blank(),
      panel.background = element_rect(fill = "white"),
      panel.border = element_blank(),
      plot.title= element_text(face="bold", size=24)
    )
}
clearcutpal <- c("#7f4f24", "#718355")
salvagepal <- c("#e9972d", "#15616d")
fullpal <- c(clearcutpal, salvagepal)
```

#### Plot of diversity by depth
```{r}
EnM_mean <- EnM %>% 
  group_by(Depth) %>% 
  summarize(average = mean(Div)) %>%
  ungroup()
```

```{r}
QP1 <- ggplot(EnM, aes(x=Depth, y=Div)) +
    geom_boxplot(aes(colour=I("black"), fill=Depth)) +  
    labs(y="Alpha Diversity", 
         x="Depth of sample",
         fill="Disturbance History") + 
  scale_x_discrete(labels=c("0-10cm", "20-30cm")) +
        theme_boxplot_one() + 
  geom_point(data = EnM_mean, 
             mapping = aes(x= Depth, y = average),
             color="red") +
   geom_line(data = EnM_mean, 
            mapping = aes(x = Depth, y = average, group=1)) + 
  stat_compare_means(method = "t.test", label.x= 0.5) + 
  theme(legend.position = "none") +
  scale_fill_manual(values = clearcutpal)
QP1
```
#### Adding in means 
```{r}
EnM_mean2 <- EnM %>% 
  group_by(Disturbance_History) %>% 
  summarize(average = mean(Div)) %>%
  ungroup()
```

```{r}
EnM_mean3 <- EnM %>% 
  group_by(No.Fires,Depth) %>% 
  summarize(average = mean(Div))
```




```{r}
EnM$No.Fires <- as.character(EnM$No.Fires)
QP2<- ggplot(EnM, aes(x=No.Fires, y=Div)) +
    geom_boxplot(aes(colour=I("black"), fill= Depth)) +  
   labs(y="Alpha Diversity", x="Number of Fires") + 
        theme_boxplot_one() +
  scale_fill_manual(values = fullpal) + 
  geom_point(data = EnM_mean3, 
             mapping = aes(x= No.Fires, y = average),
             color="red") +
   geom_line(data = EnM_mean3, 
            mapping = aes(x = No.Fires, y = average, group=1)) + 
  stat_compare_means(method = "anova", label.x= 0.6) # not right 
QP2
```



#### Examing individual destuctive effects
```{r}
EnM$No.Fires <- as.character(EnM$No.Fires)
QP2<- ggplot(EnM, aes(x=No.Fires, y=Div)) +
    geom_boxplot(aes(colour=I("black"), fill= No.Fires)) +  
    labs(y="Alpha Diversity", x="Number of Fires") + 
        theme_boxplot_one() + 
    stat_compare_means(method = "anova", label.x= 0.6) + # This needs to be double checked - I just typed anova but don't know if its running the proper stat
   theme(legend.position = "none") +
  scale_fill_manual(values = fullpal)
QP2
```

```{r}
EnM2 <- EnM
EnM2$TSD <- as.factor(EnM2$TSD)
QP3 <- ggplot(EnM2, aes(x= TSD , y=Div)) +
    geom_boxplot(aes(colour=I("black"), fill= TSD)) +  
    labs(y="Alpha Diversity", x="Time Since Destuction") + 
  theme_boxplot_one() +
    theme(legend.position = "none") +
  scale_fill_manual(values = fullpal) + 
  stat_compare_means(method = "anova", label.x= 0.6) # This needs to be double checked - I just typed anova but don't know if its running the proper stat
QP3
```

```{r}
EnM$Clearcut <- as.character(EnM$Clearcut)
QP4<- ggplot(EnM, aes(x=Clearcut, y=Div)) +
    geom_boxplot(aes(colour=I("black"), fill= Clearcut)) +  
    labs(y="Alpha Diversity", fill="Number of Fires") + 
  stat_compare_means(method = "t.test", label.x= 0.5) +
  theme_boxplot_one() + 
    theme(legend.position = "none") +
  scale_fill_manual(values = clearcutpal)
QP4
```

```{r}
EnM$Salvage <- as.character(EnM$Salvage)
QP5<- ggplot(EnM, aes(x=Salvage, y=Div)) +
    geom_boxplot(aes(colour=I("black"), fill= Depth)) +  
    labs(y="Alpha Diversity", fill="Number of Fires") + 
  stat_compare_means(method = "t.test", label.x= 0.5) +
    theme_boxplot_one() +
  scale_fill_manual(values = clearcutpal) +
    theme(legend.position = "none") 
QP5
```


# By disturbance history
```{r}
QP6<- ggplot(EnM, aes(x=reorder(Disturbance_History,-TSD), y=Div)) +
    geom_boxplot(aes(colour=I("black"), fill=Disturbance_History)) +  
    labs(y="Alpha Diversity", 
         x="Disturbance History",
         fill="Disturbance History") + 
  
   geom_point(data = EnM_mean2, 
             mapping = aes(x= Disturbance_History, y = average),
             color="red") +
   geom_line(data = EnM_mean2, 
            mapping = aes(x = Disturbance_History, y = average, group=1)) + 
  theme_boxplot_one() +
  theme(legend.position = "none", axis.text.x = element_text(angle = 15, vjust = 1, hjust=1)) +
      stat_compare_means(method = "anova", label.x= 1.5) # This needs to be double checked - I just typed anova but don't know if its running the proper stat
QP6
```

```{r}
grid.arrange(QP1, arrangeGrob(QP2, QP3, ncol=2), arrangeGrob(QP4, QP5, ncol=2), QP6, nrow = 4)
```

```{r}
layout <- rbind(c(1,2), c(3,4))
gt <- grid.arrange(                                    
             QP2, QP3,
             QP4, QP5,
             ncol = 2, nrow = 6, 
             layout_matrix = layout,
            newpage = TRUE)
```

